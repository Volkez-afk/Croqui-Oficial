<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel do Servidor – Solicitações de Croqui</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase.js"></script>
</head>
<body>

<div class="sidebar">
    <h2><i class="fas fa-user-tie"></i> Painel do Servidor</h2>
    
    <div class="menu-item active" onclick="abrirAba('pendentes', this)">
        <i class="fas fa-clock"></i> Solicitações Pendentes
    </div>
    
    <div class="menu-item" onclick="abrirAba('analise', this)">
        <i class="fas fa-search"></i> Em Análise
    </div>
    
    <div class="menu-item" onclick="abrirAba('atendidas', this)">
        <i class="fas fa-check-circle"></i> Atendidas
    </div>
</div>

<div class="content">

<div class="header-info">
    <h1>Sistema de Gerenciamento de Croquis</h1>
    <div>
        <span class="servidor-info" id="nomeServidor"></span>
        <button class="logout-btn" onclick="logout()">Sair</button>
    </div>
</div>

<div id="listaContainer" class="card">
    <h3 id="tituloLista">Solicitações Pendentes</h3>
    <div id="listaSolicitacoes"></div>
</div>

<div id="detalhesContainer" class="card hidden">
    <h3 id="tituloDetalhes"></h3>
    <div id="detalhesConteudo"></div>

    <div id="acoesAnalise" class="acoes-container">
        <input type="file" id="arquivoDeferir" accept=".pdf">
        <button class="btn btn-primary" onclick="deferir()">Deferir</button>
        <textarea id="motivoIndeferir" placeholder="Motivo indeferimento"></textarea>
        <button class="btn btn-danger" onclick="indeferir()">Indeferir</button>
    </div>
</div>

</div>

<script>

let servidorLogado = JSON.parse(sessionStorage.getItem("servidorLogado"));
let solicitacaoAtual = null;
let abaAtual = 'pendentes';

document.getElementById("nomeServidor").innerText = servidorLogado.nome;

async function carregarSolicitacoes(){

let { data } = await supabase
.from("solicitacoes")
.select("*");

renderizar(data);

}

function renderizar(lista){

let div = document.getElementById("listaSolicitacoes");
div.innerHTML="";

lista.filter(s=> s.status==abaAtual).forEach(s=>{

let el = document.createElement("div");
el.className="solicitacao-item";

el.innerHTML=`
<b>${s.numero}</b><br>
${s.nome}<br>
<button onclick='abrir(${JSON.stringify(s)})'>Abrir</button>
`;

div.appendChild(el);

});

}

function abrir(s){
solicitacaoAtual=s;

document.getElementById("detalhesContainer").classList.remove("hidden");

document.getElementById("detalhesConteudo").innerHTML=`
Nome: ${s.nome}<br>
IPTU: ${s.iptu}<br>
<a target="_blank" href="${s.pdf_solicitado_url}">Ver PDF enviado</a>
`;

}

async function deferir(){

let file = document.getElementById("arquivoDeferir").files[0];

let path = "croquis/"+Date.now()+".pdf";

await supabase.storage.from("croquis").upload(path,file);

let {data}=supabase.storage.from("croquis").getPublicUrl(path);

await supabase.from("solicitacoes")
.update({
status:"atendidas",
resultado:"deferido",
pdf_final_url:data.publicUrl
})
.eq("id",solicitacaoAtual.id);

alert("Deferido!");
carregarSolicitacoes();

}

async function indeferir(){

let motivo=document.getElementById("motivoIndeferir").value;

await supabase.from("solicitacoes")
.update({
status:"atendidas",
resultado:"indeferido",
motivo:motivo
})
.eq("id",solicitacaoAtual.id);

alert("Indeferido!");
carregarSolicitacoes();

}

function abrirAba(a){
abaAtual=a;
carregarSolicitacoes();
}

function logout(){
sessionStorage.clear();
location.href="index.html";
}

carregarSolicitacoes();

</script>
</body>
</html>
